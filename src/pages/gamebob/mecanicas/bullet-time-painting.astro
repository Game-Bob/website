---
export const prerender = true;
import MechanicPage from "../../../components/gamebob/mechanics/MechanicPage.astro";
import MechanicCanvas from "../../../components/gamebob/mechanics/MechanicCanvas.astro";
import MechanicInfo from "../../../components/gamebob/mechanics/MechanicInfo.astro";
import { Icon } from "astro-icon/components";

const GITHUB_BASE =
    "https://github.com/Game-Bob/website/tree/main/src/mechanics/bullet-time-painting";
const CODE_URL =
    "https://github.com/Game-Bob/website/blob/main/src/mechanics/bullet-time-painting/BulletTimeGame.ts";
---

<MechanicPage
    title="Bullet-Time Painting"
    description="Planifica tus tácticas y disparos en tiempo pausado. Ejecútalo en ráfagas de 1 segundo de acción pura."
    githubUrl={GITHUB_BASE}
    codeUrl={CODE_URL}

    image="/images/gamebob/mechanics/bullet-time-painting.webp"
>
    <Icon slot="icon" name="mdi:strategy" style="color: var(--color-primary)" />

    <div style="max-width: 80rem; margin: 0 auto; padding: 2.5rem 1.5rem; display: flex; flex-direction: column; gap: var(--space-2xl);">
        <div style="position: relative;">
            <div style="display: flex; flex-direction: column; background: var(--bg-main); border-radius: var(--radius-3xl); overflow: hidden; border: 1px solid var(--white-10); box-shadow: 0 50px 100px -30px var(--black-90);">
                <div style="display: grid; grid-template-columns: 1fr; gap: var(--space-2xl); padding: var(--space-2xl) var(--space-xl); background: var(--black-80); backdrop-filter: blur(24px); border-bottom: 1px solid var(--white-10);">
                    
                    <div class="ui-grid">
                        <div style="display: flex; flex-direction: column; gap: var(--space-xs);">
                            <span style="font-size: 0.65rem; font-weight: 900; color: var(--accent-50); text-transform: uppercase; letter-spacing: 0.5em;">Tactical Sector</span>
                            <div style="display: flex; align-items: center; gap: var(--space-md);">
                                <h2 id="sector-display" style="font-size: 3rem; font-weight: 900; color: var(--text-main); font-style: italic; letter-spacing: -0.05em; line-height: 1;">Sector 001</h2>
                                <div id="status-dot" style="height: 0.75rem; width: 0.75rem; border-radius: var(--radius-full); background-color: var(--color-primary); box-shadow: 0 0 20px var(--color-primary);"></div>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: var(--space-lg);">
                            <div style="display: flex; flex-direction: column; gap: var(--space-xs);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                    <span style="font-size: 0.7rem; font-weight: 900; color: var(--secondary-80); text-transform: uppercase; letter-spacing: 0.2em;">Integridad</span>
                                    <div id="hp-segments" style="display: flex; gap: var(--space-xs);">
                                        
                                        <div class="hp-seg"></div>
                                        <div class="hp-seg"></div>
                                        <div class="hp-seg"></div>
                                    </div>
                                </div>
                                <div style="height: 0.5rem; background: rgb(24 24 27 / 50%); border-radius: var(--radius-full); overflow: hidden; border: 1px solid var(--white-10);">
                                    <div id="hp-bar-fill" style="height: 100%; background: var(--color-secondary); border-radius: var(--radius-full); transition: width 1s; box-shadow: 0 0 20px var(--secondary-40); width: 100%;"></div>
                                </div>
                            </div>

                            <div style="display: flex; flex-direction: column; gap: var(--space-xs);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                    <span style="font-size: 0.7rem; font-weight: 900; color: var(--accent-80); text-transform: uppercase; letter-spacing: 0.2em;">Energía</span>
                                    <span id="energy-percent" style="font-size: 0.875rem; font-weight: 900; color: var(--color-primary); font-variant-numeric: tabular-nums;">100%</span>
                                </div>
                                <div style="height: 0.5rem; background: rgb(24 24 27 / 50%); border-radius: var(--radius-full); overflow: hidden; border: 1px solid var(--white-10);">
                                    <div id="energy-bar-fill" style="height: 100%; background: var(--color-primary); border-radius: var(--radius-full); transition: width 0.5s; box-shadow: 0 0 20px var(--accent-40); width: 100%;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: var(--space-sm);">
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: var(--space-xs);">
                                <span style="font-size: 0.6rem; font-weight: 900; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em;">Estado Sistema</span>
                                <div id="phase-display" style="font-size: 0.75rem; font-weight: 900; color: #f4f4f5; text-transform: uppercase; letter-spacing: 0.3em; background: var(--white-5); padding: 0.5rem 1.5rem; border-radius: var(--radius-md); border: 1px solid var(--white-10); font-style: italic;">Ready_Control</div>
                            </div>
                            <div style="display: flex; gap: var(--space-md);">
                                <div style="display: flex; align-items: center; gap: var(--space-xs);">
                                    <div style="width: 0.5rem; height: 0.5rem; border-radius: var(--radius-full); background: var(--color-primary); box-shadow: 0 0 10px var(--color-primary);"></div>
                                    <span style="font-size: 0.6rem; color: var(--text-muted); font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em;">Alpha</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: var(--space-xs);">
                                    <div style="width: 0.5rem; height: 0.5rem; border-radius: var(--radius-full); background: var(--color-secondary); box-shadow: 0 0 10px var(--color-secondary);"></div>
                                    <span style="font-size: 0.6rem; color: var(--text-muted); font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em;">Hostil</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="position: relative; background: var(--bg-main);">
                    <MechanicCanvas
                        id="game-canvas"
                        instruction=""
                        subInstruction=""
                        verticalOnMobile={true}

                    />
                    <div style="position: absolute; inset: 0; pointer-events: none; background-image: linear-gradient(rgb(18 16 16 / 0%) 50%, var(--black-20) 50%), linear-gradient(90deg, rgb(255 0 0 / 6%), rgb(0 255 0 / 2%), rgb(0 0 255 / 6%)); background-size: 100% 2px, 3px 100%; z-index: 10; opacity: 20%;"></div>
                    <div style="position: absolute; inset: 0; pointer-events: none; box-shadow: inset 0 0 150px var(--black-90); z-index: 20;"></div>
                </div>
            </div>
        </div>
    </div>

    <MechanicInfo>
        <Fragment slot="how-it-works">
            <li>
                <span style="color: var(--color-primary)">•</span>
                <span>Progresión por sectores: cada nivel es un nuevo desafío generado proceduralmente.</span>
            </li>
            <li>
                <span style="color: var(--color-primary)">•</span>
                <span>Pool de energía fijo: gestiona tus movimientos y disparos con inteligencia en cada turno.</span>
            </li>
            <li>
                <span style="color: var(--color-primary)">•</span>
                <span>Integridad del casco: dispones de un sistema de HP que se restaura al limpiar cada sector.</span>
            </li>
        </Fragment>

        <Fragment slot="controls">
             <div class="control-item" style="grid-column: span 2;">
                <span class="control-key">Click Izquierdo</span>
                <span class="control-desc">Moverse</span>
            </div>
             <div class="control-item" style="grid-column: span 2;">
                <span class="control-key">Click Derecho</span>
                <span class="control-desc">Disparar</span>
            </div>
             <div class="control-item" style="grid-column: span 2;">
                <span class="control-key">Espacio</span>
                <span class="control-desc">Ejecutar</span>
            </div>
        </Fragment>
    </MechanicInfo>
</MechanicPage>

<style>
    .hp-seg {
        width: 1rem;
        height: 1rem;
        border-radius: 0.125rem;
        background: var(--color-secondary);
        box-shadow: 0 0 15px var(--secondary-50);
    }

    .ui-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-lg);
        width: 100%;
    }

    @media (width >= 768px) {
        .ui-grid {
            grid-template-columns: repeat(3, 1fr);
            align-items: center;
        }
    }

</style>

<style is:global>
    .canvas-wrapper {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
        aspect-ratio: 1600 / 1200;
        background: var(--bg-main);
    }

    #game-canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
        image-rendering: crisp-edges;
        cursor: crosshair;
        object-fit: contain;
    }

</style>

<script>
    import { BulletTimeGame } from "../../../mechanics/bullet-time-painting/BulletTimeGame";

    const canvas = document.getElementById("game-canvas") as HTMLCanvasElement;
    const overlay = document.getElementById("game-canvas-overlay");

    const sectorDisplay = document.getElementById("sector-display");
    const energyBarFill = document.getElementById("energy-bar-fill");
    const energyPercent = document.getElementById("energy-percent");
    const hpBarFill = document.getElementById("hp-bar-fill");
    const hpSegments = document.getElementById("hp-segments");
    const phaseDisplay = document.getElementById("phase-display");
    const statusDot = document.getElementById("status-dot");

    let game: BulletTimeGame | null = null;

    if (canvas && overlay) {
        overlay.addEventListener("click", () => {
            overlay.style.opacity = "0";
            overlay.style.pointerEvents = "none";

            if (!game) {
                game = new BulletTimeGame(canvas);
                game.start();
                updateUI();
            }
        });

        window.addEventListener("resize", () => {
            game?.resize();
        });

        window.addEventListener("keydown", (e) => {
            if (e.code === "Space") {
                game?.playAction();
                e.preventDefault();
            }
        });

        function updateUI() {
            if (game) {
                const state = (game as any).state;
                if (state) {
                    if (sectorDisplay)
                        sectorDisplay.textContent = `sector ${state.level.toString().padStart(3, "0")}`;
                    if (energyBarFill) energyBarFill.style.width = `${state.energy}%`;
                    if (energyPercent) energyPercent.textContent = `${Math.round(state.energy)}%`;
                    if (hpBarFill) hpBarFill.style.width = `${(state.hp / state.maxHp) * 100}%`;

                    if (hpSegments) {
                        const segments = hpSegments.children;
                        for (let i = 0; i < segments.length; i++) {
                            const seg = segments[i] as HTMLElement;
                            if (i < state.hp) {
                                seg.style.opacity = "1";
                            }

 else {
                                seg.style.opacity = "0.1";
                            }
                        }
                    }

                    if (phaseDisplay) {
                        phaseDisplay.textContent = state.isExecutionPhase
                            ? "Tactical_Blitz"
                            : "Planning_Routine";
                        phaseDisplay.style.color = state.isExecutionPhase ? "var(--color-primary)" : "var(--text-main)";
                    }
                    if (statusDot) {
                        statusDot.style.backgroundColor = state.isExecutionPhase
                            ? "var(--color-secondary)"
                            : "var(--color-primary)";
                    }
                }
            }
            requestAnimationFrame(updateUI);
        }
    }
</script>
