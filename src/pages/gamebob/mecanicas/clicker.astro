---
export const prerender = true;
import MechanicPage from "../../../components/gamebob/mechanics/MechanicPage.astro";
import MechanicCanvas from "../../../components/gamebob/mechanics/MechanicCanvas.astro";
import MechanicInfo from "../../../components/gamebob/mechanics/MechanicInfo.astro";
import { Icon } from "astro-icon/components";

const GITHUB_BASE = "https://github.com/Game-Bob/website/tree/main/src/mechanics/clicker";
const CODE_URL =
    "https://github.com/Game-Bob/website/blob/main/src/mechanics/clicker/ClickerMechanic.ts";
---

<MechanicPage
    title="Clicker"
    description="El poder del crecimiento exponencial. Un click hoy, un imperio ma√±ana."
    githubUrl={GITHUB_BASE}
    codeUrl={CODE_URL}

    image="/images/gamebob/mechanics/clicker.webp"
>
    <Icon slot="icon" name="mdi:cursor-default-click" style="color: #fbbf24" />

    <div style="position: relative;">
        <MechanicCanvas
            id="game-canvas"
            instruction="Haz Click"
            subInstruction="Genera monedas"
            verticalOnMobile={true}

        >
            <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 20; pointer-events: none;">
                <button
                    id="click-btn"
                    class="click-btn"
                    style="width: 12rem; height: 12rem; border-radius: 9999px; background: linear-gradient(to bottom right, #fbbf24, #d97706); box-shadow: 0 0 50px rgba(251,191,36,0.3); transition: transform 0.075s; display: flex; align-items: center; justify-content: center; pointer-events: auto; cursor: pointer; border: none;"
                >
                    <Icon
                        name="mdi:cursor-default-click"
                        style="width: 6rem; height: 6rem; color: white; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));"
                    />
                </button>
            </div>

            <div style="position: absolute; top: 2rem; left: 0; right: 0; text-align: center; z-index: 20; pointer-events: none;">
                <h2 id="currency-display" style="font-size: 2.25rem; font-weight: 900; color: #fbbf24; filter: drop-shadow(0 10px 8px rgba(0,0,0,0.04)); margin: 0;">
                    0
                </h2>
                <p style="color: rgba(255,255,255,0.5); font-family: monospace; font-size: 0.75rem; margin-top: 0.25rem; text-transform: uppercase;">MONEDAS</p>
                <p id="gps-display" style="color: rgba(251,191,36,0.7); font-family: monospace; font-size: 0.75rem; margin-top: 0.125rem;">
                    0 por segundo
                </p>
            </div>
        </MechanicCanvas>
    </div>

    <div style="margin-top: 2rem;">
        <h3 style="font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <Icon name="mdi:store" style="color: #4ade80;" />
            Tienda de Mejoras
        </h3>
        <div id="upgrades-list" style="display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem;"></div>
    </div>

    <MechanicInfo>
        <Fragment slot="how-it-works">
            <li>
                <span>‚Ä¢</span>
                <span>Clics manuales generan recursos inmediatos.</span>
            </li>
            <li>
                <span>‚Ä¢</span>
                <span>Inversi√≥n en automatizaci√≥n para crecimiento pasivo.</span>
            </li>
            <li>
                <span>‚Ä¢</span>
                <span>Escalado exponencial de costes y producci√≥n.</span>
            </li>
        </Fragment>

        <Fragment slot="controls">
            <div class="control-item">
                <span class="control-key">Click / Tap</span>
                <span class="control-desc">Generar Monedas</span>
            </div>
        </Fragment>
    </MechanicInfo>
</MechanicPage>

<style>
    @media (min-width: 768px) {
        #upgrades-list {
            grid-template-columns: repeat(2, 1fr) !important;
        }
    }
    
    .click-btn:active {
        transform: scale(0.95);
    }

</style>

<script>
    import { ClickerGame, formatNumber } from "../../../mechanics/clicker/ClickerGame";

    const canvas = document.getElementById("game-canvas") as HTMLCanvasElement;
    const overlay = document.getElementById("game-canvas-overlay");
    const clickBtn = document.getElementById("click-btn");
    const currencyDisplay = document.getElementById("currency-display");
    const gpsDisplay = document.getElementById("gps-display");
    const upgradesList = document.getElementById("upgrades-list");

    let game: ClickerGame | null = null;

    if (canvas && overlay && clickBtn && currencyDisplay && gpsDisplay && upgradesList) {
        game = new ClickerGame(canvas);
        const start = () => {
            overlay.style.opacity = "0";
            overlay.style.pointerEvents = "none";
        };
        overlay.addEventListener("click", start);
        clickBtn.addEventListener("click", start);

        clickBtn.addEventListener("mousedown", () => {
            if (!game) return;

            const rect = canvas.getBoundingClientRect();
            const x = rect.width / 2;
            const y = rect.height / 2;

            game.click(x + (Math.random() - 0.5) * 50, y + (Math.random() - 0.5) * 50);
            updateUI();

            clickBtn.style.transform = "scale(0.90)";
            setTimeout(() => (clickBtn.style.transform = "scale(1)"), 50);
        });

        
        const setStyle = (el: HTMLElement, styles: Partial<CSSStyleDeclaration>) => {
            Object.assign(el.style, styles);
        };

        function initShop() {
            if (!game || !upgradesList) return;
            const state = game.state;
            upgradesList.innerHTML = "";

            state.upgrades.forEach((u) => {
                const btn = document.createElement("button");
                btn.id = `upgrade-btn-${u.id}`;
                btn.className = "upgrade-btn";
                
                
                setStyle(btn, {
                    width: '100%',
                    padding: '1rem',
                    borderRadius: '0.75rem',
                    border: '1px solid #3f3f46',
                    textAlign: 'left',
                    transition: 'all 0.2s',
                    background: '#27272a',
                    cursor: 'pointer',
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '0.25rem'
                });

                btn.onmouseenter = () => {
                   if (!btn.disabled) btn.style.background = '#3f3f46';
                };
                btn.onmouseleave = () => {
                   if (!btn.disabled) btn.style.background = '#27272a';
                };

                btn.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.25rem;">
                        <span style="font-weight: 700; color: white;">${u.name}</span>
                        <span style="font-family: monospace; color: #fbbf24;" id="upgrade-count-${u.id}">${u.count}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div style="font-size: 0.75rem; color: #a1a1aa;">
                            ${(u.type as any) === "click" ? "+" + u.power + " clic" : "+" + u.power + "/s"}
                        </div>
                        <div style="font-family: monospace; font-size: 0.875rem;" id="upgrade-cost-${u.id}">
                            ${formatNumber(u.cost)} üí∞
                        </div>
                    </div>
                `;

                btn.onclick = () => {
                    if (game && game.buyUpgrade(u.id)) {
                        updateUI();
                        btn.style.transform = "scale(0.98)";
                        setTimeout(() => (btn.style.transform = "scale(1)"), 50);
                    }
                };

                upgradesList.appendChild(btn);
            });
        }

        function updateUI() {
            if (!game) return;
            const state = game.state;
            if (currencyDisplay) currencyDisplay.innerText = formatNumber(state.currency);
            if (gpsDisplay)
                gpsDisplay.innerText = `${formatNumber(state.autoClickRate)} por segundo`;

            state.upgrades.forEach((u) => {
                const btn = document.getElementById(`upgrade-btn-${u.id}`) as HTMLButtonElement;
                const costEl = document.getElementById(`upgrade-cost-${u.id}`);
                const countEl = document.getElementById(`upgrade-count-${u.id}`);

                if (!btn || !costEl || !countEl) return;

                const canAfford = state.currency >= u.cost;

                if (canAfford) {
                    btn.disabled = false;
                    btn.style.opacity = "1";
                    btn.style.cursor = "pointer";
                    btn.style.borderColor = "rgba(251, 191, 36, 0.5)"; 
                    costEl.style.color = "#fbbf24";
                } else {
                    btn.disabled = true;
                    btn.style.opacity = "0.5";
                    btn.style.cursor = "not-allowed";
                    btn.style.borderColor = "#3f3f46";
                    costEl.style.color = "#f87171";
                }
                
                countEl.innerText = u.count.toString();
                costEl.innerText = `${formatNumber(u.cost)} üí∞`;
            });
        }

        function uiLoop() {
            if (game && game.state.autoClickRate > 0) {
                updateUI();
            }
            requestAnimationFrame(uiLoop);
        }

        window.addEventListener("resize", () => {
            if (game) game.resize();
        });
        
        
        
        if (game) {
             const saveInterval = setInterval(() => game?.save(), 10000);
        }

        initShop();
        updateUI();
        uiLoop();
    }
</script>
