---
import MechanicPage from "../../../components/gamebob/mechanics/MechanicPage.astro";
import ClickerUI from "../../../components/gamebob/mechanics/ClickerUI.astro";
import MechanicInfo from "../../../components/gamebob/mechanics/MechanicInfo.astro";
import { Icon } from "astro-icon/components";
import { ui } from "../../../i18n/ui";
import { useTranslations } from "../../../i18n/utils";
import { getGitHubUrls } from "../../../config/github";

export async function getStaticPaths() {
    return Object.keys(ui).map((lang) => ({
        params: { lang }
    }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as any);

const { repo: GITHUB_BASE, code: CODE_URL } = getGitHubUrls("clicker");
---

<MechanicPage
    title={t("mechanics.clicker.title")}
    description={t("mechanics.clicker.description")}
    githubUrl={GITHUB_BASE}
    codeUrl={CODE_URL}
    image="/images/gamebob/mechanics/clicker.webp"
    lang={lang}
>
    <Icon slot="icon" name="mdi:cursor-default-click" class="text-green-400" />

    <ClickerUI lang={lang} />

    <MechanicInfo>
        <Fragment slot="how-it-works">
            <li class="flex items-start gap-2">
                <span class="text-blue-400 mt-1">•</span>
                <span>{t("mechanics.clicker.howItWorks.accumulation")}</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-blue-400 mt-1">•</span>
                <span>{t("mechanics.clicker.howItWorks.automation")}</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="text-blue-400 mt-1">•</span>
                <span>{t("mechanics.clicker.howItWorks.upgrades")}</span>
            </li>
        </Fragment>

        <Fragment slot="controls">
            <div class="mechanic-control-item full-width">
                <span class="mechanic-control-label">{t("mechanics.clicker.controls.click")}</span>
                <span class="mechanic-control-sublabel">{t("mechanics.clicker.controls.earn")}</span>
            </div>
        </Fragment>
    </MechanicInfo>
</MechanicPage>

<script is:inline define:vars={{
    perClick: t("mechanics.clicker.ui.perClick"),
    upgradeNames: {
        cursor: t("mechanics.clicker.upgradeNames.cursor"),
        power: t("mechanics.clicker.upgradeNames.power"),
        farm: t("mechanics.clicker.upgradeNames.farm"),
        factory: t("mechanics.clicker.upgradeNames.factory")
    }
}}>
    window.clickerTranslations = { perClick, upgradeNames };
</script>

<script>
    import { ClickerGame, formatNumber } from "../../../mechanics/clicker/ClickerGame";

    const canvas = document.getElementById("clicker-canvas") as HTMLCanvasElement;
    const button = document.getElementById("clicker-button") as HTMLButtonElement;
    const currencyEl = document.getElementById("clicker-currency");
    const rateEl = document.getElementById("clicker-rate");
    const upgradesEl = document.getElementById("clicker-upgrades");

    if (canvas && button && currencyEl && rateEl && upgradesEl) {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;

        const game = new ClickerGame(canvas);

        function updateUI() {
            const state = game.state;
            currencyEl!.textContent = formatNumber(state.currency);
            rateEl!.textContent = formatNumber(state.autoClickRate);
            renderUpgrades(state.upgrades, state.currency);
        }

        function renderUpgrades(upgrades: any[], currency: number) {
            const translations = (window as any).clickerTranslations || {
                perClick: 'per click',
                upgradeNames: {}
            };
            upgradesEl!.innerHTML = upgrades.map(upgrade => {
                const canAfford = currency >= upgrade.cost;
                const powerText = upgrade.type === 'click'
                    ? `+${upgrade.power} ${translations.perClick}`
                    : `+${upgrade.power}/s`;
                const upgradeName = translations.upgradeNames[upgrade.id] || upgrade.name;

                return `
                    <div class="clicker-upgrade ${canAfford ? '' : 'disabled'}" data-upgrade="${upgrade.id}">
                        <div class="clicker-upgrade-header">
                            <span class="clicker-upgrade-name">${upgradeName}</span>
                            <span class="clicker-upgrade-count">${upgrade.count}</span>
                        </div>
                        <div class="clicker-upgrade-footer">
                            <span class="clicker-upgrade-cost">${formatNumber(upgrade.cost)}</span>
                            <span class="clicker-upgrade-power">${powerText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        button.addEventListener("click", (e) => {
            const rect = button.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const canvasRect = canvas.getBoundingClientRect();
            const buttonRect = button.getBoundingClientRect();
            const canvasX = buttonRect.left - canvasRect.left + x;
            const canvasY = buttonRect.top - canvasRect.top + y;

            game.click(canvasX, canvasY);
            updateUI();
        });

        upgradesEl.addEventListener("click", (e) => {
            const target = (e.target as HTMLElement).closest(".clicker-upgrade") as HTMLElement;
            if (target && !target.classList.contains("disabled")) {
                const upgradeId = target.dataset.upgrade;
                if (upgradeId && game.buyUpgrade(upgradeId)) {
                    updateUI();
                }
            }
        });

        window.addEventListener("resize", () => {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            game.resize();
        });

        setInterval(updateUI, 100);
        updateUI();
    }
</script>
